<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestion des Professeurs</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: Verdana, sans-serif; background-color: #f7f7f7; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { text-align: center; color: #1a1a1a; }
        .controls { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between; }
        input[type="text"] { padding: 10px; border-radius: 4px; border: 1px solid #ddd; width: 250px; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #2193b0; color: white; font-weight: bold; }
        tr:hover { background-color: #f9f9f9; }
        .status { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .status.pending { background-color: #fff3cd; color: #856404; }
        .status.validated { background-color: #d4edda; color: #155724; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 8px 12px; border-radius: 4px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 14px; transition: opacity 0.3s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .validate-btn { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        .back-home { display: inline-block; margin-top: 20px; padding: 10px 15px; color: #2193b0; text-decoration: none; border: 1px solid #2193b0; border-radius: 4px; transition: all 0.3s; }
        .back-home:hover { background-color: #2193b0; color: white; }
        .empty-state { text-align: center; padding: 40px; color: #666; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .modal-content h3 { margin-top: 0; color: #333; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-cancel { background-color: #6c757d; }
        .btn-confirm { background-color: #dc3545; }
    </style>
</head>
<body>
<div class="container">
    <h1>üõ†Ô∏è Admin - Gestion des Professeurs</h1>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="üîç Chercher un professeur...">
        <button class="validate-btn" onclick="loadProfs()">üîÑ Rafra√Æchir</button>
    </div>

    <div class="table-wrapper">
        <table id="profTable">
            <thead>
            <tr>
                <th>#</th>
                <th>Nom Complet</th>
                <th>Statut</th>
                <th>Heures en ligne ce mois</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Professeurs inject√©s ici -->
            </tbody>
        </table>
    </div>

    <div style="text-align:center;">
        <a href="index.html" class="back-home">‚¨ÖÔ∏è Retour √† l'accueil</a>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Confirmation</h3>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Annuler</button>
            <button class="btn-confirm" id="confirmBtn" onclick="confirmAction()">Confirmer</button>
        </div>
    </div>
</div>

<script>
let profs = [];
let filteredProfs = [];
let pendingAction = null;

async function loadProfs() {
    try {
        const res = await fetch("/api/professeurs/avec_heures");
        const data = await res.json();
        profs = data.map(p => ({
            ...p,
            fullname: `${p.prenom} ${p.nom}`,
            heures_en_ligne: p.heures_en_ligne || 0
        }));
        filteredProfs = [...profs];
        displayProfs();
    } catch (err) {
        console.error(err);
        alert("Erreur chargement des professeurs");
    }
}

function displayProfs() {
    const tbody = document.querySelector("#profTable tbody");
    tbody.innerHTML = "";

    if (filteredProfs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-state">Aucun professeur trouv√©.</td></tr>`;
        return;
    }

    filteredProfs.forEach((prof, index) => {
        const statusClass = prof.statut === "en_attente" ? "pending" : "validated";
        const statusText = prof.statut === "en_attente" ? "‚è≥ En attente" : "‚úÖ Valid√©";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${escapeHtml(prof.fullname)}</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
            <td>${prof.heures_en_ligne} h</td>
            <td>
                <div class="actions">
                    ${prof.statut === "en_attente" ? `<button class="validate-btn" onclick="openValidateModal(${index})">Valider</button>` : ""}
                    <button class="delete-btn" onclick="openDeleteModal(${index})">Supprimer</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
}

function openValidateModal(index) {
    pendingAction = { type: "validate", index };
    const prof = filteredProfs[index];
    document.getElementById("modalTitle").textContent = "Valider ce professeur ?";
    document.getElementById("modalMessage").textContent = `√ätes-vous s√ªr de valider "${escapeHtml(prof.fullname)}" ?`;
    document.getElementById("confirmModal").style.display = "block";
}

function openDeleteModal(index) {
    pendingAction = { type: "delete", index };
    const prof = filteredProfs[index];
    document.getElementById("modalTitle").textContent = "Supprimer ce professeur ?";
    document.getElementById("modalMessage").textContent = `Attention : "${escapeHtml(prof.fullname)}" sera d√©finitivement supprim√©.`;
    document.getElementById("confirmBtn").className = "btn-confirm";
    document.getElementById("confirmModal").style.display = "block";
}

async function confirmAction() {
    if (!pendingAction) return;
    const { type, index } = pendingAction;
    const prof = filteredProfs[index];

    if (type === "validate") {
        try {
            const res = await fetch(`/api/auth/professeurs/${prof.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ statut: "valide" })
            });
            if (res.ok) alert(`‚úÖ "${prof.fullname}" valid√©.`);
            else alert("‚ùå Erreur lors de la validation");
        } catch (err) { console.error(err); alert("‚ùå Erreur lors de la validation"); }
    } else if (type === "delete") {
        try {
            const res = await fetch(`/api/auth/professeurs/${prof.id}`, { method: "DELETE" });
            if (res.ok) alert(`‚ùå "${prof.fullname}" supprim√©.`);
            else alert("‚ùå Erreur lors de la suppression");
        } catch (err) { console.error(err); alert("‚ùå Erreur lors de la suppression"); }
    }
    closeModal();
    loadProfs();
}

function closeModal() {
    pendingAction = null;
    document.getElementById("confirmModal").style.display = "none";
}

document.getElementById("searchInput").addEventListener("keyup", e => {
    const query = e.target.value.toLowerCase();
    filteredProfs = profs.filter(p => p.fullname.toLowerCase().includes(query));
    displayProfs();
});

document.addEventListener("keydown", e => {
    if (e.key === "Escape") closeModal();
});

loadProfs();
</script>
</body>
</html>
