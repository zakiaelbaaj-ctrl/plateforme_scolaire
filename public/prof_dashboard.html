<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Professeur</title>
<style>
* { box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
.header { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.header h1 { margin: 0; color: #333; font-size: 24px; }
.header-info { color: #666; font-size: 13px; }
.logout-btn { padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
.logout-btn:hover { background: #c82333; }
.card { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
.card h2 { margin: 0 0 16px 0; color: #333; font-size: 18px; }
.setup-section { background: #e3f2fd; border: 1px solid #90caf9; }
.setup-input { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.setup-input input, .setup-input select { padding: 8px 12px; border: 1px solid #90caf9; border-radius: 4px; font-size: 13px; }
.setup-input button { padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
.setup-input button:hover { background: #218838; }
.container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
@media(max-width:1200px) { .container { grid-template-columns: 1fr; } }
.eleve-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; background: #f9f9f9; }
.eleve-info { flex: 1; }
.eleve-name { font-weight: 600; color: #333; }
.eleve-meta { font-size: 12px; color: #666; margin-top: 4px; }
.eleve-subject { display: inline-block; padding: 3px 8px; background: #e3f2fd; color: #007bff; border-radius: 3px; font-size: 11px; font-weight: 500; margin-right: 6px; }
.eleve-country { display: inline-block; padding: 2px 6px; background: #fff3cd; border-radius: 3px; font-size: 11px; }
.eleve-actions { display: flex; gap: 6px; flex-direction: column; }
button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
.accept { background: #28a745; color: white; }
.accept:hover { background: #218838; }
.reject { background: #dc3545; color: white; }
.reject:hover { background: #c82333; }
.primary { background: #007bff; color: white; }
.primary:hover { background: #0056b3; }
.call-section { display: none; }
.call-section.active { display: block; }
.videos-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.video-box { background: #000; border-radius: 8px; overflow: hidden; height: 300px; }
.video-box video { width: 100%; height: 100%; object-fit: cover; }
.video-label { font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 500; }
.controls { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #eee; }
.timer { font-weight: 600; color: #dc3545; font-size: 18px; }
.chat-box { display: flex; flex-direction: column; height: 250px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 6px; }
.chat-messages { flex: 1; overflow-y: auto; padding: 12px; background: #f9f9f9; }
.chat-message { margin-bottom: 8px; }
.msg-sender { font-weight: 600; color: #007bff; font-size: 12px; }
.msg-text { color: #333; padding: 4px 0; word-wrap: break-word; }
.chat-input { display: flex; gap: 8px; }
#chatInput { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
.files-list { list-style: none; padding: 0; margin: 0; }
.files-list li { padding: 8px; background: #f9f9f9; border-radius: 4px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
.file-name { color: #007bff; font-weight: 500; font-size: 13px; }
.no-eleve { text-align: center; padding: 40px 20px; color: #999; }
.empty-list { padding: 20px; text-align: center; color: #999; }
.stats-badge { display: inline-block; background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; }
.filter-section { margin-bottom: 12px; padding: 12px; background: #f0f7ff; border-radius: 4px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.filter-section select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
hr { border: none; border-top: 1px solid #eee; margin: 16px 0; }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>ğŸ‘¨â€ğŸ« Dashboard Professeur</h1>
    <div class="header-info">ConnectÃ© : <strong id="profLabel">â€”</strong></div>
  </div>
  <button class="logout-btn" id="logoutBtn">ğŸšª DÃ©connexion</button>
</div>

<div class="card setup-section" id="setupSection">
  <h2>âš™ï¸ Configuration Profil</h2>
  <div class="setup-input">
    <input type="text" id="profCountryInput" placeholder="Votre pays" value="France">
    <select id="profSubjectsInput" multiple>
      <option value="MathÃ©matiques">ğŸ“ MathÃ©matiques</option>
      <option value="FranÃ§ais">ğŸ“š FranÃ§ais</option>
      <option value="Anglais">ğŸ—£ï¸ Anglais</option>
      <option value="Physique">âš›ï¸ Physique</option>
      <option value="Chimie">ğŸ§ª Chimie</option>
      <option value="Histoire">ğŸ›ï¸ Histoire</option>
      <option value="GÃ©ographie">ğŸ—ºï¸ GÃ©ographie</option>
      <option value="Biologie">ğŸ”¬ Biologie</option>
    </select>
    <button id="saveProfileBtn" class="accept">Sauvegarder Profil</button>
  </div>
</div>

<div class="container" id="mainContainer" style="display:none;">
  
  <div class="card">
    <h2>ğŸ“‹ Salle d'attente <span class="stats-badge" id="waitingCount">0</span></h2>
    <div class="filter-section">
      <select id="subjectFilterProf">
        <option value="">ğŸ“š Toutes les matiÃ¨res</option>
      </select>
    </div>
    <div id="elevesList" class="empty-list">Aucun Ã©lÃ¨ve en attente</div>
  </div>

  <div class="card call-section" id="callSection">
    <h2>ğŸ“ Appel avec <span id="currentEleve">â€”</span></h2>
    
    <div class="videos-container">
      <div>
        <div class="video-label">ğŸ“¹ Votre vidÃ©o</div>
        <div class="video-box">
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
      </div>
      <div>
        <div class="video-label">ğŸ‘¤ Ã‰lÃ¨ve</div>
        <div class="video-box">
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="endCallBtn" class="reject">ğŸ”´ Terminer</button>
      <div class="timer">â±ï¸ <span id="callTimer">00:00</span></div>
    </div>

    <hr>
    <h3 style="margin:0 0 12px 0; font-size:14px;">ğŸ’¬ Chat</h3>
    <div class="chat-box">
      <div class="chat-messages" id="chatMessages"></div>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Votre message...">
      <button id="sendChatBtn" class="primary">Envoyer</button>
    </div>

    <hr>
    <h3 style="margin:0 0 12px 0; font-size:14px;">ğŸ“ Fichiers</h3>
    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <input type="file" id="fileInput" style="flex:1;">
      <button id="sendFileBtn" class="primary">Envoyer</button>
    </div>
    <ul class="files-list" id="filesList"></ul>
  </div>

  <div class="no-eleve" id="noEleveSection">
    <p>ğŸ‘‡ SÃ©lectionnez un Ã©lÃ¨ve Ã  gauche</p>
  </div>
</div>

<script>
const saved = JSON.parse(localStorage.getItem('profConnecte') || 'null');
const profUsername = saved?.username || null;
const profPre = saved?.prenom || '';
const profNom = saved?.nom || '';

if (!profUsername) {
  alert('âŒ Non connectÃ©');
  location.href = './login.html';
}

let profCountry = 'France';
let profSubjects = ['MathÃ©matiques', 'FranÃ§ais'];
let currentEleve = null;
let pc = null;
let localStream = null;
let timerInterval = null;
let callStart = null;
let allAppels = [];
let ws = null;

function getWebSocketURL() {
  let host = location.host;
  if (!host || host === '') host = 'localhost:4000';
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const url = `${protocol}//${host}`;
  console.log('ğŸ”— WebSocket URL:', url);
  return url;
}

function initWebSocket() {
  const WS_URL = getWebSocketURL();
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    console.log('âœ… WS connectÃ©');
    ws.send(JSON.stringify({ 
      type: 'register', 
      username: profUsername, 
      role: 'prof',
      country: profCountry,
      subjects: profSubjects
    }));
  };

  ws.onmessage = async (evt) => {
    try {
      const data = JSON.parse(evt.data);
      
      if (data.type === 'appelEnAttente') {
        allAppels = data.appels || [];
        populateFilters();
        filterWaiting();
      }
      
      if (data.type === 'chat' && data.sender === currentEleve) {
        addChatMessage(data.sender, data.message);
      }
      
      if (data.type === 'newFile' && data.sender === currentEleve) {
        addFileToList(data.filename, data.sender, data.content);
      }
      
      // WEBRTC - RECEVOIR L'OFFRE DE L'Ã‰LÃˆVE
      if (data.type === 'offer' && data.sender === currentEleve) {
        console.log('ğŸ“¥ OFFRE reÃ§ue de:', currentEleve);
        if (!pc) {
          console.log('ğŸ”„ CrÃ©ation RTCPeerConnection...');
          await initPeerConnection();
        }
        console.log('ğŸ“¥ DÃ©finition remote description (offer)');
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        console.log('ğŸ“ CrÃ©ation answer...');
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        console.log('ğŸ“¤ Envoi ANSWER');
        ws.send(JSON.stringify({ type: 'answer', target: currentEleve, answer: answer }));
      }
      
      if (data.type === 'answer' && data.sender === currentEleve && pc) {
        console.log('ğŸ“¥ ANSWER reÃ§ue');
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
      
      if (data.type === 'ice' && data.sender === currentEleve && pc && data.candidate) {
        try {
          console.log('ğŸ“¥ ICE candidate reÃ§u');
          if (pc.remoteDescription?.type) {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          }
        } catch (e) {
          console.warn('âŒ ICE error:', e.message);
        }
      }
    } catch (e) {
      console.error('âŒ WS error:', e);
    }
  };

  ws.onclose = () => {
    console.log('âŒ WS fermÃ©');
    setTimeout(initWebSocket, 3000);
  };
}

initWebSocket();

function saveProfProfile() {
  profCountry = document.getElementById('profCountryInput').value.trim() || 'France';
  const subjectsSelect = document.getElementById('profSubjectsInput');
  profSubjects = Array.from(subjectsSelect.selectedOptions).map(option => option.value);
  
  if (profSubjects.length === 0) {
    alert('SÃ©lectionnez au moins une matiÃ¨re');
    return;
  }
  
  document.getElementById('profLabel').textContent = `${profPre} ${profNom} (${profCountry})`;
  document.getElementById('setupSection').style.display = 'none';
  document.getElementById('mainContainer').style.display = 'grid';
  
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ 
      type: 'updateProfProfile', 
      username: profUsername, 
      country: profCountry,
      subjects: profSubjects
    }));
  }
}

function logout() {
  localStorage.removeItem('profConnecte');
  if (ws) ws.close();
  location.href = '/login.html';
}

document.getElementById('profLabel').textContent = `${profPre} ${profNom}`;
document.getElementById('saveProfileBtn').addEventListener('click', saveProfProfile);
document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('subjectFilterProf').addEventListener('change', filterWaiting);
document.getElementById('sendChatBtn').addEventListener('click', sendChat);
document.getElementById('sendFileBtn').addEventListener('click', sendFile);
document.getElementById('endCallBtn').addEventListener('click', endCall);

function populateFilters() {
  const subjects = [...new Set(allAppels.map(a => a.subject).filter(Boolean))];
  const subSelect = document.getElementById('subjectFilterProf');
  
  subSelect.innerHTML = '<option value="">ğŸ“š Toutes les matiÃ¨res</option>';
  subjects.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    subSelect.appendChild(opt);
  });
}

function filterWaiting() {
  const subFilter = document.getElementById('subjectFilterProf').value;
  
  const filtered = allAppels.filter(a => {
    const subject = a.subject || '';
    const matchSub = !subFilter || subject === subFilter;
    return matchSub;
  });
  
  renderWaiting(filtered);
}

function renderWaiting(appels) {
  const ul = document.getElementById('elevesList');
  ul.innerHTML = '';
  
  if (!appels || appels.length === 0) {
    document.getElementById('waitingCount').textContent = '0';
    ul.innerHTML = '<div class="empty-list">Aucun Ã©lÃ¨ve en attente</div>';
    return;
  }

  document.getElementById('waitingCount').textContent = appels.length;

  appels.forEach(a => {
    const name = a.eleve || 'Inconnu';
    const subject = a.subject || 'Non spÃ©cifiÃ©e';
    
    const div = document.createElement('div');
    div.className = 'eleve-item';
    div.innerHTML = `
      <div class="eleve-info">
        <div class="eleve-name">${name}</div>
        <div class="eleve-meta">
          <span class="eleve-subject">ğŸ“š ${subject}</span>
        </div>
      </div>
      <div class="eleve-actions">
        <button class="accept" onclick="acceptCall('${name}')">âœ… Accepter</button>
        <button class="reject" onclick="rejectCall('${name}')">âŒ Rejeter</button>
      </div>
    `;
    ul.appendChild(div);
  });
}

async function acceptCall(eleve) {
  currentEleve = eleve;
  document.getElementById('currentEleve').textContent = eleve;
  document.getElementById('callSection').classList.add('active');
  document.getElementById('noEleveSection').style.display = 'none';
  
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'accepterAppel', prof: profUsername, eleve }));
  }
  
  await initPeerConnection();
  startTimer();
}

function rejectCall(eleve) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'rejeterAppel', prof: profUsername, eleveRejete: eleve }));
  }
}

function endCall() {
  if (!currentEleve) return;
  const duration = Math.floor((Date.now() - callStart) / 1000);
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'appelTermine', prof: profUsername, eleve: currentEleve, duration }));
  }
  stopTimer();
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  currentEleve = null;
  pc = null;
  localStream = null;
  document.getElementById('callSection').classList.remove('active');
  document.getElementById('noEleveSection').style.display = 'block';
  document.getElementById('chatMessages').innerHTML = '';
  document.getElementById('filesList').innerHTML = '';
}

function startTimer() {
  callStart = Date.now();
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - callStart) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const s = String(elapsed % 60).padStart(2, '0');
    document.getElementById('callTimer').textContent = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  document.getElementById('callTimer').textContent = '00:00';
}

function sendChat() {
  const msg = document.getElementById('chatInput').value.trim();
  if (!msg || !currentEleve) return;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'chat', target: currentEleve, message: msg }));
  }
  addChatMessage('Vous', msg);
  document.getElementById('chatInput').value = '';
}

function addChatMessage(sender, message) {
  const box = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-message';
  div.innerHTML = `
    <div class="msg-sender">${sender}</div>
    <div class="msg-text">${message}</div>
  `;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function sendFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file || !currentEleve) return;
  const reader = new FileReader();
  reader.onload = () => {
    const b64 = reader.result.split(',')[1];
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'fileUpload',
        target: currentEleve,
        filename: file.name,
        content: b64
      }));
    }
    addFileToList(file.name, 'Vous', null);
    document.getElementById('fileInput').value = '';
  };
  reader.readAsDataURL(file);
}

function addFileToList(filename, from, content) {
  const ul = document.getElementById('filesList');
  const li = document.createElement('li');
  if (content) {
    const blob = base64ToBlob(content);
    const url = URL.createObjectURL(blob);
    li.innerHTML = `<a href="${url}" download="${filename}">ğŸ“„ ${filename}</a>`;
  } else {
    li.innerHTML = `<span class="file-name">ğŸ“„ ${filename}</span>`;
  }
  ul.appendChild(li);
}

function base64ToBlob(b64) {
  const bytes = atob(b64);
  const arr = new Uint8Array(bytes.length);
  for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
  return new Blob([arr]);
}

async function initPeerConnection() {
  if (pc) return;
  
  console.log('ğŸ”„ CrÃ©ation RTCPeerConnection (prof)...');
  
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'stun:stun2.l.google.com:19302' },
      { urls: 'stun:stun3.l.google.com:19302' },
      { urls: 'stun:stun4.l.google.com:19302' },
      {
        urls: 'turn:openrelay.metered.ca:80',
        username: 'openrelay',
        credential: 'openrelay'
      },
      {
        urls: 'turn:openrelay.metered.ca:443',
        username: 'openrelay',
        credential: 'openrelay'
      },
      {
        urls: 'turn:openrelay.metered.ca:443?transport=tcp',
        username: 'openrelay',
        credential: 'openrelay'
      }
    ]
  });

  try {
    console.log('ğŸ¤ Demande accÃ¨s camÃ©ra/micro (prof)...');
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    console.log('âœ… Flux local obtenu (prof)');
    document.getElementById('localVideo').srcObject = localStream;
    localStream.getTracks().forEach(t => {
      console.log('ğŸ“¹ Track ajoutÃ©:', t.kind);
      pc.addTrack(t, localStream);
    });
  } catch (err) {
    console.error('âŒ Erreur camÃ©ra (prof):', err);
    alert('Erreur camÃ©ra: ' + err.message);
    return;
  }

  pc.ontrack = (ev) => {
    console.log('ğŸ¥ Flux distant reÃ§u (prof):', ev.streams);
    console.log('ğŸ¬ Track type:', ev.track.kind);
    if (ev.streams && ev.streams[0]) {
      console.log('âœ… Assignation flux distant Ã  remoteVideo (prof)');
      const videoElement = document.getElementById('remoteVideo');
      if (videoElement) {
        videoElement.srcObject = ev.streams[0];
        videoElement.play().catch(err => console.error('Erreur play:', err));
      }
    }
  };

  pc.onicecandidate = (ev) => {
    if (ev.candidate && currentEleve && ws && ws.readyState === 1) {
      console.log('ğŸ“¤ Envoi ICE candidate (prof)');
      ws.send(JSON.stringify({ type: 'ice', target: currentEleve, candidate: ev.candidate }));
    }
  };

  pc.onconnectionstatechange = () => {
    console.log('ğŸ”— Connexion Ã©tat (prof):', pc.connectionState);
  };

  pc.onsignalingstatechange = () => {
    console.log('ğŸ“¡ Signaling Ã©tat (prof):', pc.signalingState);
  };

  pc.oniceconnectionstatechange = () => {
    console.log('ğŸ§Š ICE connection state (prof):', pc.iceConnectionState);
  };

  pc.onicegatheringstatechange = () => {
    console.log('ğŸ“ ICE gathering state (prof):', pc.iceGatheringState);
  };

  pc.oniceerror = (ev) => {
    console.error('âŒ ICE error (prof):', ev);
  };
}

document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') document.getElementById('sendChatBtn')?.click();
});
</script>

</body>
</html>