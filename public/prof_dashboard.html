<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Professeur</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; margin:0; padding:20px; background:#f0f2f5; }

    .header { background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; }
    .header h1 { margin:0; color:#333; font-size:24px; }
    .header-info { color:#666; font-size:13px; }
    .logout-btn { padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500; }
    .logout-btn:hover { background:#c82333; }

    .card { background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    .card h2 { margin:0 0 16px 0; color:#333; font-size:18px; }

    .setup-section { background:#e3f2fd; border:1px solid #90caf9; }
    .setup-input { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .setup-input input, .setup-input select { padding:8px 12px; border:1px solid #90caf9; border-radius:4px; font-size:13px; }
    .setup-input button { padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:500; }
    .setup-input button:hover { background:#218838; }

    .container { display:grid; grid-template-columns: 1fr 2fr; gap:20px; }

    .list { display:flex; flex-direction:column; gap:10px; }
    .student { display:flex; justify-content:space-between; align-items:center; border:1px solid #eee; border-radius:6px; padding:10px; background:#fff; }
    .student-info { display:flex; flex-direction:column; font-size:13px; color:#444; }
    .student-actions { display:flex; gap:8px; }
    .btn { padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:500; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-primary:hover { background:#0069d9; }
    .btn-warning { background:#ffc107; color:#333; }
    .btn-danger { background:#dc3545; color:#fff; }
    .btn-danger:hover { background:#c82333; }

    .call-status { font-size:14px; color:#555; }
    .muted { color:#888; font-size:12px; }
    .badge { background:#eef2ff; color:#334; border:1px solid #ccd; border-radius:12px; padding:2px 8px; font-size:12px; }

    .notif { position:fixed; right:20px; bottom:20px; background:#222; color:#fff; padding:12px 16px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2); opacity:0; transform:translateY(10px); transition:opacity .2s, transform .2s; }
    .notif.show { opacity:1; transform:translateY(0); }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div>
      <h1>üë®‚Äçüè´ Dashboard Professeur</h1>
      <div class="header-info">
        Connect√© : <strong id="profLabel">‚Äî</strong> |
        Mati√®res : <strong id="matiereLabel">‚Äî</strong> |
        Pays : <strong id="paysLabel">‚Äî</strong>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
  </div>

  <!-- SECTION CONFIGURATION -->
  <div class="card setup-section" id="setupSection">
    <h2>‚öôÔ∏è Configuration Profil</h2>
    <div class="setup-input">
      <input type="text" id="profNameInput" placeholder="Votre nom (ex: Mme Dupont)" value="Professeur">
      <input type="text" id="profCountryInput" placeholder="Votre pays (ex: France)" value="France">
      <select id="profSubjectsInput" multiple>
        <option value="Math√©matiques">üìò Math√©matiques</option>
        <option value="Fran√ßais">üìö Fran√ßais</option>
        <option value="Anglais">üó£Ô∏è Anglais</option>
        <option value="Physique">üî¨ Physique</option>
      </select>
      <input type="text" id="profLanguagesInput" placeholder="Langues (ex: Fran√ßais, Anglais)" value="Fran√ßais,Anglais">
      <button onclick="saveProfProfile()">Sauvegarder Profil</button>
    </div>
    <p class="muted">Astuce: maintenez Ctrl/‚åò pour s√©lectionner plusieurs mati√®res.</p>
  </div>

  <!-- CONTAINER PRINCIPAL -->
  <div class="container" id="mainContainer" style="display:none;">
    <!-- Liste d‚Äôattente -->
    <div class="card">
      <h2>üìã Salle d'attente</h2>
      <div id="elevesList" class="list"></div>
      <div class="muted" id="waitingHint">Aucun √©l√®ve en attente</div>
    </div>

    <!-- Appel en cours -->
    <div class="card">
      <h2>üìû Appel en cours</h2>
      <div class="call-status" id="callSection">‚Äî</div>
      <div class="student-actions" id="callActions" style="margin-top:12px; display:none;">
        <button class="btn btn-warning" onclick="startCall(currentStudentId)">Relancer</button>
        <button class="btn btn-danger" onclick="endCall()">Terminer</button>
      </div>
      <div id="callMeta" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notif" class="notif"></div>

  <!-- SCRIPT GLOBAL (doit rester en bas) -->
  <script>
    // √âtat global
    const state = {
      ws: null,
      connected: false,
      profile: { name: 'Professeur', country: 'France', subjects: [], languages: [] },
      waiting: [],
      currentCall: null
    };

    // Utilitaires
    function byId(id) { return document.getElementById(id); }
    function nowISO() { return new Date().toISOString(); }
    function formatTime(ts) {
      try { return new Date(ts).toLocaleString(); } catch { return ts; }
    }
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Rendus
    function renderProfile() {
      byId('profLabel').textContent = state.profile.name || 'Professeur';
      byId('matiereLabel').textContent = (state.profile.subjects || []).join(', ') || '‚Äî';
      byId('paysLabel').textContent = state.profile.country || '‚Äî';
    }

    function renderWaiting() {
      const container = byId('elevesList');
      container.innerHTML = '';
      if (state.waiting.length === 0) {
        byId('waitingHint').style.display = 'block';
        return;
      }
      byId('waitingHint').style.display = 'none';

      state.waiting.forEach(s => {
        const row = document.createElement('div');
        row.className = 'student';
        row.innerHTML = `
          <div class="student-info">
            <strong>${escapeHTML(s.name)}</strong>
            <span>Classe: ${escapeHTML(s.grade || '‚Äî')} ¬∑ Sujet: ${escapeHTML(s.topic || '‚Äî')}</span>
            <span class="badge">Arriv√©: ${formatTime(s.arrivedAt)}</span>
          </div>
          <div class="student-actions">
            <button class="btn btn-primary" onclick="startCall('${s.id}')">D√©marrer</button>
            <button class="btn" onclick="removeFromWaiting('${s.id}')">Retirer</button>
          </div>
        `;
        container.appendChild(row);
      });
    }

    function renderCall() {
      const callSection = byId('callSection');
      const actions = byId('callActions');
      const meta = byId('callMeta');

      if (!state.currentCall) {
        callSection.textContent = '‚Äî';
        actions.style.display = 'none';
        meta.textContent = '';
        return;
      }
      const c = state.currentCall;
      callSection.textContent = `Avec ${c.student.name} (Sujet: ${c.student.topic || '‚Äî'})`;
      actions.style.display = 'flex';
      meta.textContent = `D√©but: ${formatTime(c.startedAt)} ¬∑ ID: ${c.student.id}`;
    }

    // Notifications
    function notify(message, level = 'ok') {
      const el = byId('notif');
      el.textContent = message;
      el.style.background = level === 'error' ? '#b00020'
                         : level === 'warn' ? '#6a4'
                         : '#222';
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1800);
    }

    // WebSocket (optionnel)
    function connectWS(url) {
      const paramUrl = new URLSearchParams(location.search).get('ws');
      const wsUrl = url || paramUrl;

      if (!wsUrl) {
        console.warn('WS: aucun URL fourni, mode local.');
        state.connected = false;
        return null;
      }

      try {
        const ws = new WebSocket(wsUrl);
        state.ws = ws;

        ws.onopen = () => {
          state.connected = true;
          notify('Connect√© au serveur', 'ok');
          ws.send(JSON.stringify({ type: 'prof_connect', payload: { profile: state.profile } }));
        };

        ws.onmessage = (evt) => {
          let msg;
          try { msg = JSON.parse(evt.data); } catch { return; }
          switch (msg.type) {
            case 'waiting_update':
              state.waiting = Array.isArray(msg.payload) ? msg.payload : [];
              renderWaiting();
              break;
            case 'call_start':
              if (msg.payload && msg.payload.student) {
                state.currentCall = {
                  student: msg.payload.student,
                  startedAt: msg.payload.startedAt || nowISO()
                };
                renderCall();
              }
              break;
            case 'call_end':
              state.currentCall = null;
              renderCall();
              break;
            default:
              break;
          }
        };

        ws.onerror = () => {
          state.connected = false;
          notify('Erreur WebSocket', 'error');
        };

        ws.onclose = () => {
          state.connected = false;
          notify('D√©connect√© du serveur', 'warn');
        };

        return ws;
      } catch (e) {
        console.error('WS: √©chec de connexion', e);
        state.connected = false;
        return null;
      }
    }

    // Actions
    function logout() {
      alert('D√©connexion...');
      location.href = '/login.html';
    }

    function saveProfProfile() {
      const name = byId('profNameInput').value.trim() || 'Professeur';
      const country = byId('profCountryInput').value.trim() || '‚Äî';
      const subjects = Array.from(byId('profSubjectsInput').selectedOptions).map(o => o.value);
      const languages = byId('profLanguagesInput').value.split(',').map(s => s.trim()).filter(Boolean);

      state.profile = { name, country, subjects, languages };
      renderProfile();

      byId('mainContainer').style.display = 'grid';
      notify('Profil sauvegard√©', 'ok');

      if (state.ws && state.ws.readyState === 1) {
        state.ws.send(JSON.stringify({ type: 'prof_profile', payload: state.profile }));
      }
    }

    function startCall(studentId) {
      const student = state.waiting.find(s => s.id === studentId);
      if (!student) { notify('√âl√®ve introuvable', 'error'); return; }

      state.currentCall = { student, startedAt: nowISO() };
      state.waiting = state.waiting.filter(s => s.id !== studentId);
      renderWaiting();
      renderCall();

      if (state.ws && state.ws.readyState === 1) {
        state.ws.send(JSON.stringify({ type: 'call_start', payload: { student } }));
      }
    }

    function endCall() {
      if (!state.currentCall) return;
      const ended = state.currentCall;
      state.currentCall = null;
      renderCall();

      if (state.ws && state.ws.readyState === 1) {
        state.ws.send(JSON.stringify({ type: 'call_end', payload: { student: ended.student } }));
      }
      notify('Appel termin√©', 'ok');
    }

    function removeFromWaiting(studentId) {
      const before = state.waiting.length;
      state.waiting = state.waiting.filter(s => s.id !== studentId);
      renderWaiting();

      if (before !== state.waiting.length) {
        if (state.ws && state.ws.readyState === 1) {
          state.ws.send(JSON.stringify({ type: 'waiting_remove', payload: { id: studentId } }));
        }
        notify('√âl√®ve retir√© de la file', 'warn');
      }
    }

    // Initialisation
    function initDashboard(options = {}) {
      renderProfile();
      renderWaiting();
      renderCall();
      connectWS(options.wsUrl);

      // Mode d√©mo local si pas de serveur WS
      if (!state.ws) {
        setTimeout(() => {
          state.waiting = [
            { id: 'stu-001', name: 'Lina', grade: '6e', topic: 'Fractions', arrivedAt: nowISO() },
            { id: 'stu-002', name: 'Karim', grade: '5e', topic: 'Grammaire', arrivedAt: nowISO() }
          ];
          renderWaiting();
        }, 600);
      }

      // Sanity check (doit afficher "function function")
      console.log(typeof saveProfProfile, typeof logout);
    }

    // Auto-init quand le DOM est pr√™t
    document.addEventListener('DOMContentLoaded', () => {
      initDashboard(); // passez initDashboard({ wsUrl: 'wss://votre-serveur/ws' }) si besoin
    });
  </script>
</body>
</html>
