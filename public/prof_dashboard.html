<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Professeur</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: 'Segoe UI', sans-serif; margin:0; padding:20px; background:#f0f2f5; }
  
  .header { background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; }
  .header h1 { margin:0; color:#333; font-size:24px; }
  .header-info { color:#666; font-size:13px; }
  .logout-btn { padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500; }
  .logout-btn:hover { background:#c82333; }
  
  .card { background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
  .card h2 { margin:0 0 16px 0; color:#333; font-size:18px; }
  
  .setup-section { background:#e3f2fd; border:1px solid #90caf9; }
  .setup-input { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .setup-input input, .setup-input select { padding:8px 12px; border:1px solid #90caf9; border-radius:4px; font-size:13px; }
  .setup-input button { padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:500; }
  .setup-input button:hover { background:#218838; }
  
  .container { display:grid; grid-template-columns: 1fr 2fr; gap:20px; }
  @media(max-width:1200px) { .container { grid-template-columns: 1fr; } }
  
  .filter-section { margin-bottom:12px; padding:12px; background:#f0f7ff; border-radius:4px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .filter-section label { font-weight:500; color:#333; font-size:12px; }
  .filter-section select { padding:6px 10px; border:1px solid #ddd; border-radius:4px; font-size:12px; }
  
  .eleve-item { display:flex; justify-content:space-between; align-items:flex-start; padding:12px; border:1px solid #eee; border-radius:6px; margin-bottom:8px; background:#f9f9f9; }
  .eleve-info { flex:1; }
  .eleve-name { font-weight:600; color:#333; }
  .eleve-meta { font-size:12px; color:#666; margin-top:4px; }
  .eleve-subject { display:inline-block; padding:3px 8px; background:#e3f2fd; color:#007bff; border-radius:3px; font-size:11px; font-weight:500; margin-right:6px; }
  .eleve-country { display:inline-block; padding:2px 6px; background:#fff3cd; border-radius:3px; font-size:11px; }
  .eleve-time { font-size:12px; color:#999; margin-top:2px; }
  .eleve-actions { display:flex; gap:6px; flex-direction:column; }
  
  button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:500; transition:all 0.2s; }
  .accept { background:#28a745; color:white; }
  .accept:hover { background:#218838; }
  .reject { background:#dc3545; color:white; }
  .reject:hover { background:#c82333; }
  .primary { background:#007bff; color:white; }
  .primary:hover { background:#0056b3; }
  .secondary { background:#6c757d; color:white; }
  .secondary:hover { background:#5a6268; }
  
  .call-section { display:none; }
  .call-section.active { display:block; }
  
  .videos-container { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px; }
  .video-box { background:#000; border-radius:8px; overflow:hidden; height:300px; }
  .video-box video { width:100%; height:100%; object-fit:cover; }
  .video-label { font-size:12px; color:#666; margin-bottom:4px; font-weight:500; }
  
  .controls { display:flex; gap:8px; align-items:center; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #eee; }
  .timer { font-weight:600; color:#dc3545; font-size:18px; }
  
  .chat-box { display:flex; flex-direction:column; height:250px; margin-bottom:16px; border:1px solid #ddd; border-radius:6px; }
  .chat-messages { flex:1; overflow-y:auto; padding:12px; background:#f9f9f9; }
  .chat-message { margin-bottom:8px; }
  .msg-sender { font-weight:600; color:#007bff; font-size:12px; }
  .msg-text { color:#333; padding:4px 0; word-wrap:break-word; }
  .msg-time { font-size:11px; color:#999; margin-top:2px; }
  
  .chat-input { display:flex; gap:8px; }
  #chatInput { flex:1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:13px; }
  
  .files-list { list-style:none; padding:0; margin:0; }
  .files-list li { padding:8px; background:#f9f9f9; border-radius:4px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
  .file-name { color:#007bff; font-weight:500; font-size:13px; }
  .file-info { font-size:11px; color:#999; }
  
  .file-upload { display:flex; gap:8px; margin-bottom:12px; }
  #fileInput { flex:1; }
  
  .no-eleve { text-align:center; padding:40px 20px; color:#999; }
  .empty-list { padding:20px; text-align:center; color:#999; }
  
  .eleve-detail { background:#f0f7ff; padding:10px; border-radius:4px; margin-bottom:12px; font-size:12px; border-left:4px solid #007bff; }
  
  .stats-badge { display:inline-block; background:#007bff; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:8px; }
  
  hr { border:none; border-top:1px solid #eee; margin:16px 0; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div>
    <h1>ğŸ‘¨â€ğŸ« Dashboard Professeur</h1>
    <div class="header-info">ConnectÃ© : <strong id="profLabel">â€”</strong> | MatiÃ¨res : <strong id="matiereLabel">â€”</strong> | Pays : <strong id="paysLabel">â€”</strong></div>
  </div>
  <button class="logout-btn" onclick="logout()">ğŸšª DÃ©connexion</button>
</div>

<!-- SETUP SECTION -->
<div class="card setup-section" id="setupSection">
  <h2>âš™ï¸ Configuration Profil</h2>
  <div class="setup-input">
    <input type="text" id="profCountryInput" placeholder="Votre pays (ex: France)" value="France">
    <select id="profSubjectsInput" multiple style="width:250px; padding:8px 12px; border:1px solid #90caf9; border-radius:4px;">
      <option value="MathÃ©matiques">ğŸ“ MathÃ©matiques</option>
      <option value="FranÃ§ais">ğŸ“š FranÃ§ais</option>
      <option value="Anglais">ğŸ—£ï¸ Anglais</option>
      <option value="Physique">âš›ï¸ Physique</option>
      <option value="Chimie">ğŸ§ª Chimie</option>
      <option value="Histoire">ğŸ›ï¸ Histoire</option>
      <option value="GÃ©ographie">ğŸ—ºï¸ GÃ©ographie</option>
      <option value="Biologie">ğŸ”¬ Biologie</option>
      <option value="Informatique">ğŸ’» Informatique</option>
      <option value="Philosophie">ğŸ¤” Philosophie</option>
      <option value="Espagnol">ğŸ‡ªğŸ‡¸ Espagnol</option>
      <option value="Allemand">ğŸ‡©ğŸ‡ª Allemand</option>
    </select>
    <button onclick="saveProfProfile()" class="accept">Sauvegarder Profil</button>
  </div>
  <p style="font-size:12px; color:#666; margin-top:8px;">ğŸ’¡ Maintenez Ctrl (ou Cmd) pour sÃ©lectionner plusieurs matiÃ¨res</p>
</div>

<!-- CONTAINER PRINCIPAL -->
<div class="container" id="mainContainer" style="display:none;">
  
  <!-- SALLE D'ATTENTE (Gauche) -->
  <div class="card">
    <h2>ğŸ“‹ Salle d'attente <span class="stats-badge" id="waitingCount">0</span></h2>
    
    <div class="filter-section">
      <select id="subjectFilterProf" onchange="filterWaiting()">
        <option value="">ğŸ“š Toutes les matiÃ¨res</option>
      </select>
      <select id="countryFilterProf" onchange="filterWaiting()">
        <option value="">ğŸŒ Tous les pays</option>
      </select>
    </div>
    
    <div id="elevesList" class="empty-list">Aucun Ã©lÃ¨ve en attente</div>
  </div>

  <!-- APPEL EN COURS (Droite) -->
  <div class="card call-section" id="callSection">
    <h2>ğŸ“ Appel avec <span id="currentEleve">â€”</span></h2>
    
    <div class="eleve-detail" id="eleveDetailBox"></div>
    
    <!-- VIDÃ‰OS -->
    <div class="videos-container">
      <div>
        <div class="video-label">ğŸ“¹ Votre vidÃ©o</div>
        <div class="video-box">
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
      </div>
      <div>
        <div class="video-label">ğŸ‘¤ Ã‰lÃ¨ve</div>
        <div class="video-box">
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>
    </div>

    <!-- CONTRÃ”LES -->
    <div class="controls">
      <button id="endCallBtn" class="reject">ğŸ”´ Terminer</button>
      <div class="timer">â±ï¸ <span id="callTimer">00:00</span></div>
    </div>

    <hr>

    <!-- CHAT -->
    <h3 style="margin:0 0 12px 0; font-size:14px;">ğŸ’¬ Chat</h3>
    <div class="chat-box">
      <div class="chat-messages" id="chatMessages"></div>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Votre message...">
      <button id="sendChatBtn" class="primary">Envoyer</button>
    </div>

    <hr>

    <!-- FICHIERS -->
    <h3 style="margin:0 0 12px 0; font-size:14px;">ğŸ“ Partage de fichiers</h3>
    <div class="file-upload">
      <input type="file" id="fileInput">
      <button id="sendFileBtn" class="primary">Envoyer</button>
    </div>
    <ul class="files-list" id="filesList"></ul>
  </div>

  <!-- PAS D'APPEL -->
  <div class="no-eleve" id="noEleveSection">
    <p>ğŸ‘‡ SÃ©lectionnez un Ã©lÃ¨ve Ã  gauche pour commencer</p>
  </div>
</div>

<script>
// ===== DONNÃ‰ES UTILISATEUR =====
const saved = JSON.parse(localStorage.getItem('profConnecte') || 'null');
const profUsername = saved?.username || null;
const profPre = saved?.prenom || '';
const profNom = saved?.nom || '';
const profMatiere = saved?.matiere || '';

if (!profUsername) {
  alert('âŒ Non connectÃ©');
  location.href = '/login_prof.html';
}

let profCountry = localStorage.getItem('prof_country') || 'France';
let profSubjects = (localStorage.getItem('prof_subjects') || profMatiere || 'MathÃ©matiques,FranÃ§ais').split(',').map(s => s.trim());
let profLanguages = (localStorage.getItem('prof_languages') || 'FranÃ§ais,Anglais').split(',').map(l => l.trim());

let currentEleve = null;
let currentEleveCountry = null;
let currentEleveSubject = null;
let pc = null;
let localStream = null;
let timerInterval = null;
let callStart = null;
let allAppels = [];
let filteredAppels = [];

// ===== WEBSOCKET =====
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
const ws = new WebSocket(WS_URL);

ws.onopen = () => {
  console.log('âœ… WS connectÃ©');
  ws.send(JSON.stringify({ 
    type: 'register', 
    username: profUsername, 
    role: 'prof',
    country: profCountry,
    subjects: profSubjects,
    languages: profLanguages
  }));
};

ws.onmessage = async (evt) => {
  try {
    const data = JSON.parse(evt.data);
    
    if (data.type === 'appelEnAttente' || data.type === 'listeEleves') {
      allAppels = data.appels || data.eleves || [];
      populateFilters();
      filterWaiting();
    }
    
    if (data.type === 'chat' && data.sender === currentEleve) {
      addChatMessage(data.sender, data.message, data.timestamp);
    }
    
    if (data.type === 'newFile' && data.sender === currentEleve) {
      addFileToList(data.filename, data.sender, data.content);
    }
    
    if (data.type === 'timerUpdate') {
      updateTimer(data.elapsed || 0);
    }
    
    // WebRTC
    if (data.type === 'offer' && data.sender === currentEleve) {
      if (!pc) await initPeerConnection();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ type: 'answer', target: currentEleve, answer }));
    }
    
    if (data.type === 'answer' && data.sender === currentEleve && pc) {
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
    
    if (data.type === 'ice' && data.sender === currentEleve && pc && data.candidate) {
      try {
        if (pc.remoteDescription?.type) {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      } catch (e) {
        console.warn('ICE error:', e);
      }
    }
  } catch (e) {
    console.error('WS error:', e);
  }
};

ws.onclose = () => console.log('âŒ WS fermÃ©');
ws.onerror = (err) => console.error('âŒ WS error:', err);

// ===== SAUVEGARDE PROFIL =====
function saveProfProfile() {
  profCountry = document.getElementById('profCountryInput').value.trim() || 'France';
  profLanguages = document.getElementById('profLanguagesInput').value.split(',').map(l => l.trim()).filter(l => l);
  
  const subjectsSelect = document.getElementById('profSubjectsInput');
  profSubjects = Array.from(subjectsSelect.selectedOptions).map(option => option.value);
  
  if (profSubjects.length === 0) {
    alert('SÃ©lectionnez au moins une matiÃ¨re');
    return;
  }
  
  localStorage.setItem('prof_country', profCountry);
  localStorage.setItem('prof_subjects', profSubjects.join(','));
  localStorage.setItem('prof_languages', profLanguages.join(','));
  
  document.getElementById('paysLabel').textContent = profCountry;
  document.getElementById('matiereLabel').textContent = profSubjects.join(', ');
  document.getElementById('setupSection').style.display = 'none';
  document.getElementById('mainContainer').style.display = 'grid';
  
  ws.send(JSON.stringify({ 
    type: 'updateProfProfile', 
    username: profUsername, 
    country: profCountry,
    subjects: profSubjects,
    languages: profLanguages
  }));
}

// Initialiser
document.getElementById('profLabel').textContent = `${profPre} ${profNom}`;
document.getElementById('paysLabel').textContent = profCountry;
document.getElementById('matiereLabel').textContent = profSubjects.join(', ');
document.getElementById('profCountryInput').value = profCountry;
document.getElementById('profLanguagesInput').value = profLanguages.join(',');

Array.from(document.getElementById('profSubjectsInput').options).forEach(option => {
  if (profSubjects.includes(option.value)) option.selected = true;
});

// ===== FILTRES =====
function populateFilters() {
  const subjects = [...new Set(allAppels.map(a => a.subject).filter(Boolean))];
  const countries = [...new Set(allAppels.map(a => a.country || a.senderCountry).filter(Boolean))];
  
  const subSelect = document.getElementById('subjectFilterProf');
  const countSelect = document.getElementById('countryFilterProf');
  const curSub = subSelect.value;
  const curCount = countSelect.value;
  
  subSelect.innerHTML = '<option value="">ğŸ“š Toutes les matiÃ¨res</option>';
  subjects.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    subSelect.appendChild(opt);
  });
  subSelect.value = curSub;
  
  countSelect.innerHTML = '<option value="">ğŸŒ Tous les pays</option>';
  countries.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = `ğŸŒ ${c}`;
    countSelect.appendChild(opt);
  });
  countSelect.value = curCount;
}

function filterWaiting() {
  const subFilter = document.getElementById('subjectFilterProf').value;
  const countFilter = document.getElementById('countryFilterProf').value;
  
  filteredAppels = allAppels.filter(a => {
    const subject = a.subject || '';
    const country = a.country || a.senderCountry || '';
    const matchSub = !subFilter ? profSubjects.includes(subject) : subject === subFilter;
    const matchCount = !countFilter || country === countFilter;
    return matchSub && matchCount;
  });
  
  renderWaiting(filteredAppels);
}

function renderWaiting(appels) {
  const ul = document.getElementById('elevesList');
  ul.innerHTML = '';
  
  if (!appels || appels.length === 0) {
    document.getElementById('waitingCount').textContent = '0';
    ul.innerHTML = '<div class="empty-list">Aucun Ã©lÃ¨ve en attente</div>';
    return;
  }

  document.getElementById('waitingCount').textContent = appels.length;

  appels.forEach(a => {
    const name = a.eleve || a.username || 'Inconnu';
    const country = a.country || a.senderCountry || 'Inconnu';
    const subject = a.subject || 'Non spÃ©cifiÃ©e';
    const time = new Date(a.timestamp || Date.now()).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    
    const div = document.createElement('div');
    div.className = 'eleve-item';
    
    div.innerHTML = `
      <div class="eleve-info">
        <div class="eleve-name">${escapeHtml(name)}</div>
        <div class="eleve-meta">
          <span class="eleve-subject">ğŸ“š ${escapeHtml(subject)}</span>
          <span class="eleve-country">ğŸŒ ${escapeHtml(country)}</span>
        </div>
        <div class="eleve-time">ğŸ• ${time}</div>
      </div>
      <div class="eleve-actions">
        <button class="accept" onclick="acceptCall('${escapeHtml(name)}', '${escapeHtml(country)}', '${escapeHtml(subject)}')">âœ… Accepter</button>
        <button class="reject" onclick="rejectCall('${escapeHtml(name)}')">âŒ Rejeter</button>
      </div>
    `;
    ul.appendChild(div);
  });
}

// ===== ACCEPTER/REJETER =====
async function acceptCall(eleve, country, subject) {
  currentEleve = eleve;
  currentEleveCountry = country;
  currentEleveSubject = subject;
  
  document.getElementById('currentEleve').textContent = eleve;
  document.getElementById('eleveDetailBox').innerHTML = `
    <strong>ğŸ‘¤ Ã‰lÃ¨ve :</strong> ${escapeHtml(eleve)}<br>
    <strong>ğŸ“š MatiÃ¨re :</strong> ${escapeHtml(subject)}<br>
    <strong>ğŸŒ Pays Ã©lÃ¨ve :</strong> ${escapeHtml(country)}<br>
    <strong>ğŸŒ Votre pays :</strong> ${escapeHtml(profCountry)}<br>
    <strong>ğŸ“š Vos matiÃ¨res :</strong> ${escapeHtml(profSubjects.join(', '))}
  `;
  document.getElementById('callSection').classList.add('active');
  document.getElementById('noEleveSection').style.display = 'none';
  
  ws.send(JSON.stringify({ type: 'accepterAppel', prof: profUsername, profCountry, profSubjects, eleve }));
  
  await initPeerConnection();
  startTimer();
}

function rejectCall(eleve) {
  ws.send(JSON.stringify({ type: 'rejeterAppel', prof: profUsername, eleveRejete: eleve }));
}

// ===== FIN D'APPEL =====
document.getElementById('endCallBtn')?.addEventListener('click', () => {
  if (!currentEleve) return;
  
  ws.send(JSON.stringify({ type: 'appelTermine', prof: profUsername, eleve: currentEleve }));
  
  stopTimer();
  if (pc) {
    pc.close();
    pc = null;
  }
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  
  currentEleve = null;
  document.getElementById('callSection').classList.remove('active');
  document.getElementById('noEleveSection').style.display = 'block';
  document.getElementById('chatMessages').innerHTML = '';
  document.getElementById('filesList').innerHTML = '';
});

// ===== TIMER =====
function startTimer() {
  callStart = Date.now();
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - callStart) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const s = String(elapsed % 60).padStart(2, '0');
    document.getElementById('callTimer').textContent = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  document.getElementById('callTimer').textContent = '00:00';
}

function updateTimer(seconds) {
  const m = String(Math.floor(seconds / 60)).padStart(2, '0');
  const s = String(seconds % 60).padStart(2, '0');
  document.getElementById('callTimer').textContent = `${m}:${s}`;
}

// ===== CHAT =====
document.getElementById('sendChatBtn')?.addEventListener('click', () => {
  const msg = document.getElementById('chatInput').value.trim();
  if (!msg || !currentEleve) return;
  
  ws.send(JSON.stringify({ type: 'chat', target: currentEleve, message: msg }));
  addChatMessage('Vous', msg, new Date().toISOString());
  document.getElementById('chatInput').value = '';
});

function addChatMessage(sender, message, timestamp) {
  const box = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-message';
  const time = new Date(timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
  div.innerHTML = `
    <div class="msg-sender">${escapeHtml(sender)}</div>
    <div class="msg-text">${escapeHtml(message)}</div>
    <div class="msg-time">${time}</div>
  `;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// ===== FICHIERS =====
document.getElementById('sendFileBtn')?.addEventListener('click', () => {
  const file = document.getElementById('fileInput').files[0];
  if (!file || !currentEleve) return;
  
  const reader = new FileReader();
  reader.onload = () => {
    const b64 = reader.result.split(',')[1];
    ws.send(JSON.stringify({
      type: 'fileUpload',
      target: currentEleve,
      filename: file.name,
      content: b64
    }));
    addFileToList(file.name, 'Vous', null);
    document.getElementById('fileInput').value = '';
  };
  reader.readAsDataURL(file);
});

function addFileToList(filename, from, content) {
  const ul = document.getElementById('filesList');
  const li = document.createElement('li');
  
  if (content) {
    const blob = base64ToBlob(content);
    const url = URL.createObjectURL(blob);
    li.innerHTML = `
      <a href="${url}" download="${escapeHtml(filename)}" style="flex:1; color:#007bff; text-decoration:none;">ğŸ“„ ${escapeHtml(filename)}</a>
      <span class="file-info">de ${escapeHtml(from)}</span>
    `;
  } else {
    li.innerHTML = `
      <span class="file-name">ğŸ“„ ${escapeHtml(filename)}</span>
      <span class="file-info">de ${escapeHtml(from)}</span>
    `;
  }
  ul.appendChild(li);
}

function base64ToBlob(b64) {
  const bytes = atob(b64);
  const arr = new Uint8Array(bytes.length);
  for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
  return new Blob([arr]);
}

// ===== WEBRTC =====
async function initPeerConnection() {
  if (pc) return;
  
  pc = new RTCPeerConnection({
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  });

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  } catch (err) {
    console.error('âŒ Erreur camÃ©ra:', err);
    alert('Impossible d\'accÃ©der Ã  la camÃ©ra/micro');
  }

  pc.ontrack = (ev) => {
    document.getElementById('remoteVideo').srcObject = ev.streams[0];
  };

  pc.onicecandidate = (ev) => {
    if (ev.candidate && currentEleve) {
      ws.send(JSON.stringify({ type: 'ice', target: currentEleve, candidate: ev.candidate }));
    }
  };
}

function logout() {
  localStorage.removeItem('profConnecte');
  location.href = '/login_prof.html';
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>