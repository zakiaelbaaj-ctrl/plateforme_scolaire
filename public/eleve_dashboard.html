<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Espace √âl√®ve</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: 'Segoe UI', sans-serif; margin:0; padding:20px; background:#f0f2f5; }
  
  .header { background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
  .header h1 { margin:0 0 8px 0; color:#333; }
  .header .info { color:#666; font-size:14px; }
  
  .card { background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  .card h2 { margin:0 0 16px 0; color:#333; }
  
  .start-section { text-align:center; padding:40px 20px; }
  .start-section input { padding:10px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px; width:200px; }
  .start-section button { padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; margin-left:8px; font-weight:500; }
  .start-section button:hover { background:#0056b3; }
  
  .waiting-section { text-align:center; padding:40px 20px; color:#666; font-size:16px; }
  .waiting-section .spinner { display:inline-block; animation: spin 1s linear infinite; margin-right:10px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .call-section { display:none; }
  .call-section.active { display:block; }
  
  .videos-container { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px; }
  .video-box { background:#000; border-radius:8px; overflow:hidden; }
  .video-box video { width:100%; height:auto; display:block; }
  .video-label { font-size:12px; color:#666; margin-bottom:4px; font-weight:500; }
  
  .controls { display:flex; gap:8px; align-items:center; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #eee; }
  .timer { font-weight:600; color:#dc3545; font-size:18px; }
  
  button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:500; transition:all 0.2s; }
  .primary { background:#007bff; color:white; }
  .primary:hover { background:#0056b3; }
  .danger { background:#dc3545; color:white; }
  .danger:hover { background:#c82333; }
  
  .chat-box { display:flex; flex-direction:column; height:250px; margin-bottom:16px; border:1px solid #ddd; border-radius:6px; }
  .chat-messages { flex:1; overflow-y:auto; padding:12px; background:#f9f9f9; }
  .chat-message { margin-bottom:8px; }
  .msg-sender { font-weight:600; color:#007bff; font-size:12px; }
  .msg-text { color:#333; padding:4px 0; word-wrap:break-word; }
  .msg-time { font-size:11px; color:#999; margin-top:2px; }
  
  .chat-input { display:flex; gap:8px; }
  #chatInput { flex:1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
  
  .files-section { }
  .files-list { list-style:none; padding:0; margin:0; }
  .files-list li { padding:8px; background:#f9f9f9; border-radius:4px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
  .file-name { color:#007bff; font-weight:500; }
  .file-info { font-size:12px; color:#999; }
  
  .file-upload { display:flex; gap:8px; margin-bottom:12px; }
  #fileInput { flex:1; }
  
  hr { border:none; border-top:1px solid #eee; margin:16px 0; }
  
  .prof-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:12px; margin-top:12px; }
  .prof-card { background:#f9f9f9; padding:12px; border-radius:6px; border:1px solid #eee; cursor:pointer; transition:all 0.2s; }
  .prof-card:hover { background:#f0f0f0; border-color:#007bff; }
  .prof-name { font-weight:600; color:#333; }
  .prof-status { font-size:12px; color:#999; margin-top:4px; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h1>üéì Espace √âl√®ve</h1>
  <div class="info">
    Connect√© : <strong id="eleveLabel">‚Äî</strong>
  </div>
</div>

<!-- ZONE DE D√âMARRAGE -->
<div class="card" id="startSection">
  <div class="start-section">
    <div style="margin-bottom:20px;">
      <input type="text" id="eleveName" placeholder="Entrez votre nom" style="width:250px; padding:10px 12px; font-size:14px; border:1px solid #ddd; border-radius:6px;">
      <button onclick="initEleve()" class="primary" style="margin-left:8px; padding:10px 20px;">Continuer</button>
    </div>
  </div>
</div>

<!-- ZONE D'ATTENTE -->
<div class="card" id="waitingSection" style="display:none;">
  <div class="waiting-section">
    <div class="spinner">‚è≥</div>
    <div>En attente qu'un professeur accepte votre appel...</div>
  </div>
</div>

<!-- ZONE D'APPEL EN COURS -->
<div class="card call-section" id="callSection">
  <h2>üìû En communication avec <span id="profName">‚Äî</span></h2>
  
  <!-- VID√âOS -->
  <div class="videos-container">
    <div>
      <div class="video-label">üìπ Votre vid√©o</div>
      <div class="video-box">
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
    </div>
    <div>
      <div class="video-label">üë®‚Äçüè´ Professeur</div>
      <div class="video-box">
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>
  </div>

  <!-- CONTR√îLES -->
  <div class="controls">
    <button id="endCallBtn" class="danger">üî¥ Terminer l'appel</button>
    <div class="timer">‚è±Ô∏è <span id="callTimer">00:00</span></div>
  </div>

  <hr>

  <!-- CHAT -->
  <h3>üí¨ Chat</h3>
  <div class="chat-box">
    <div class="chat-messages" id="chatMessages"></div>
  </div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="Votre message...">
    <button id="sendChatBtn" class="primary">Envoyer</button>
  </div>

  <hr>

  <!-- FICHIERS -->
  <h3>üìÅ Partage de fichiers</h3>
  <div class="file-upload">
    <input type="file" id="fileInput">
    <button id="sendFileBtn" class="primary">Envoyer</button>
  </div>
  <ul class="files-list" id="filesList"></ul>
</div>

<!-- ZONE DE S√âLECTION DE PROF -->
<div class="card" id="profListSection" style="display:none;">
  <h2>üìö Professeurs disponibles</h2>
  <div class="prof-list" id="profList"></div>
</div>

<script>
// ========================
// VARIABLES GLOBALES
// ========================
let eleveName = null;
let profSelected = null;
let pc = null;
let localStream = null;
let timerInterval = null;
let callStart = null;
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
const ws = new WebSocket(WS_URL);

// ========================
// WEBSOCKET
// ========================
ws.onopen = () => {
  console.log('‚úÖ WebSocket connect√©');
};

ws.onmessage = async (evt) => {
  try {
    const data = JSON.parse(evt.data);
    
    // Liste des professeurs
    if (data.type === 'profList') {
      renderProfList(data.profs || []);
    }
    
    // Appel accept√©
    if (data.type === 'appelAccepte' && data.eleve === eleveName) {
      profSelected = data.prof;
      document.getElementById('profName').textContent = profSelected;
      document.getElementById('waitingSection').style.display = 'none';
      document.getElementById('callSection').classList.add('active');
      document.getElementById('profListSection').style.display = 'none';
      
      await initPeerConnection();
      startClientTimer();
    }
    
    // Appel rejet√©
    if (data.type === 'appelRejete' && data.eleve === eleveName) {
      alert('‚ùå Votre appel a √©t√© rejet√©');
      document.getElementById('waitingSection').style.display = 'none';
      document.getElementById('profListSection').style.display = 'block';
    }
    
    // Appel termin√©
    if (data.type === 'appelTermine') {
      alert('Le professeur a termin√© l\'appel');
      endCall();
    }
    
    // Chat
    if (data.type === 'chat' && data.sender !== eleveName) {
      addChatMessage(data.sender || 'Professeur', data.message, data.timestamp);
    }
    
    // Fichier
    if (data.type === 'newFile' && data.sender !== eleveName) {
      addFileToList(data.filename, data.sender || 'Professeur', data.content);
    }
    
    // WebRTC signaling
    if (data.type === 'offer' && data.sender === profSelected) {
      if (!pc) await initPeerConnection();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ type: 'answer', target: profSelected, answer }));
    }
    
    if (data.type === 'answer' && data.sender === profSelected && pc) {
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
    
    if (data.type === 'ice' && data.sender === profSelected && pc && data.candidate) {
      try {
        // V√©rifier que la description distante existe
        if (pc.remoteDescription && pc.remoteDescription.type) {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      } catch (e) {
        console.warn('ICE error:', e);
      }
    }
  } catch (e) {
    console.error('WS message error:', e);
  }
};

ws.onclose = () => console.log('‚ùå WebSocket ferm√©');
ws.onerror = (err) => console.error('‚ùå WS Error:', err);

// ========================
// INITIALISATION √âL√àVE
// ========================
function initEleve() {
  eleveName = document.getElementById('eleveName').value.trim();
  if (!eleveName) {
    alert('Entrez votre nom');
    return;
  }
  
  document.getElementById('eleveLabel').textContent = eleveName;
  document.getElementById('startSection').style.display = 'none';
  document.getElementById('profListSection').style.display = 'block';
  
  ws.send(JSON.stringify({ type: 'register', username: eleveName, role: 'eleve' }));
}

// ========================
// LISTE DES PROFESSEURS
// ========================
function renderProfList(profs) {
  const div = document.getElementById('profList');
  div.innerHTML = '';
  
  if (!profs || profs.length === 0) {
    div.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Aucun professeur disponible pour le moment</p>';
    return;
  }

  profs.forEach(prof => {
    const card = document.createElement('div');
    card.className = 'prof-card';
    card.innerHTML = `
      <div class="prof-name">üë®‚Äçüè´ ${escapeHtml(prof.username)}</div>
      <div class="prof-status">${prof.disponible ? 'üü¢ Disponible' : 'üî¥ Occup√©'}</div>
      ${prof.appelsEnAttente > 0 ? `<div class="prof-status">${prof.appelsEnAttente} appel(s) en attente</div>` : ''}
    `;
    
    if (prof.disponible || prof.appelsEnAttente === 0) {
      card.style.cursor = 'pointer';
      card.onclick = () => demanderProf(prof.username);
    } else {
      card.style.opacity = '0.6';
      card.style.cursor = 'not-allowed';
    }
    
    div.appendChild(card);
  });
}

// ========================
// DEMANDER UN PROFESSEUR
// ========================
function demanderProf(prof) {
  if (!prof) return;
  
  profSelected = prof;
  ws.send(JSON.stringify({ type: 'demandAppel', sender: eleveName, target: prof }));
  
  document.getElementById('profListSection').style.display = 'none';
  document.getElementById('waitingSection').style.display = 'block';
}

// ========================
// FIN D'APPEL
// ========================
document.getElementById('endCallBtn').addEventListener('click', endCall);

function endCall() {
  if (!profSelected) return;
  
  ws.send(JSON.stringify({ type: 'appelTermine', prof: profSelected, eleve: eleveName }));
  
  stopClientTimer();
  if (pc) {
    pc.close();
    pc = null;
  }
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  
  profSelected = null;
  document.getElementById('callSection').classList.remove('active');
  document.getElementById('waitingSection').style.display = 'none';
  document.getElementById('profListSection').style.display = 'block';
  document.getElementById('chatMessages').innerHTML = '';
  document.getElementById('filesList').innerHTML = '';
}

// ========================
// TIMER
// ========================
function startClientTimer() {
  callStart = Date.now();
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - callStart) / 1000);
    updateTimer(elapsed);
  }, 1000);
}

function updateTimer(seconds) {
  const m = String(Math.floor(seconds / 60)).padStart(2, '0');
  const s = String(seconds % 60).padStart(2, '0');
  document.getElementById('callTimer').textContent = `${m}:${s}`;
}

function stopClientTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  document.getElementById('callTimer').textContent = '00:00';
}

// ========================
// CHAT
// ========================
document.getElementById('sendChatBtn').addEventListener('click', () => {
  const msg = document.getElementById('chatInput').value.trim();
  if (!msg || !profSelected) return;
  
  ws.send(JSON.stringify({ type: 'chat', target: profSelected, message: msg }));
  addChatMessage('Vous', msg, new Date().toISOString());
  document.getElementById('chatInput').value = '';
});

function addChatMessage(sender, message, timestamp) {
  const box = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-message';
  const time = new Date(timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
  div.innerHTML = `
    <div class="msg-sender">${escapeHtml(sender)}</div>
    <div class="msg-text">${escapeHtml(message)}</div>
    <div class="msg-time">${time}</div>
  `;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// ========================
// FICHIERS
// ========================
document.getElementById('sendFileBtn').addEventListener('click', () => {
  const file = document.getElementById('fileInput').files[0];
  if (!file || !profSelected) return;
  
  const reader = new FileReader();
  reader.onload = () => {
    const b64 = reader.result.split(',')[1];
    ws.send(JSON.stringify({
      type: 'fileUpload',
      target: profSelected,
      filename: file.name,
      content: b64
    }));
    addFileToList(file.name, 'Vous', null);
    document.getElementById('fileInput').value = '';
  };
  reader.readAsDataURL(file);
});

function addFileToList(filename, from, content) {
  const ul = document.getElementById('filesList');
  const li = document.createElement('li');
  
  let html = `<span class="file-name">üìÑ ${escapeHtml(filename)}</span>`;
  html += `<span class="file-info">de ${escapeHtml(from)}</span>`;
  
  if (content) {
    const blob = base64ToBlob(content);
    const url = URL.createObjectURL(blob);
    html = `<a href="${url}" download="${escapeHtml(filename)}" style="flex:1; color:#007bff; text-decoration:none;">üìÑ ${escapeHtml(filename)}</a>`;
    html += `<span class="file-info">de ${escapeHtml(from)}</span>`;
  }
  
  li.innerHTML = html;
  ul.appendChild(li);
}

function base64ToBlob(b64) {
  const bytes = atob(b64);
  const arr = new Uint8Array(bytes.length);
  for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
  return new Blob([arr]);
}

// ========================
// WEBRTC
// ========================
async function initPeerConnection() {
  if (pc) return;
  
  pc = new RTCPeerConnection({
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  });

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  } catch (err) {
    console.error('‚ùå Erreur cam√©ra/micro:', err);
    alert('Impossible d\'acc√©der √† la cam√©ra/micro. V√©rifiez les permissions.');
  }

  pc.ontrack = (ev) => {
    document.getElementById('remoteVideo').srcObject = ev.streams[0];
  };

  pc.onicecandidate = (ev) => {
    if (ev.candidate && profSelected) {
      ws.send(JSON.stringify({ type: 'ice', target: profSelected, candidate: ev.candidate }));
    }
  };
}

// ========================
// UTILITAIRES
// ========================
function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>

</body>
</html>