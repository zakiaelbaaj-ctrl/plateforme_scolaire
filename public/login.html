<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connexion Professeur</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; }
.container { background:white; border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,0.2); width:100%; max-width:400px; padding:40px; }
h1 { text-align:center; color:#333; margin-bottom:30px; font-size:28px; }
.form-group { margin-bottom:20px; }
label { display:block; margin-bottom:8px; color:#555; font-weight:500; }
input { width:100%; padding:12px; border:2px solid #ddd; border-radius:5px; font-size:16px; transition:border-color 0.3s; }
input:focus { outline:none; border-color:#667eea; }
button { width:100%; padding:12px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:5px; font-size:16px; font-weight:600; cursor:pointer; transition: transform 0.2s; }
button:hover:not(:disabled) { transform:translateY(-2px); }
button:disabled { opacity:0.7; cursor:not-allowed; }
.error { margin-top:15px; padding:12px; background:#fee; color:#c33; border:1px solid #fcc; border-radius:5px; text-align:center; display:none; }
.error.show { display:block; }
.success { margin-top:15px; padding:12px; background:#efe; color:#3c3; border:1px solid #cfc; border-radius:5px; text-align:center; display:none; }
.success.show { display:block; }
.link-section { text-align:center; margin-top:20px; }
.link-section a { color:#667eea; text-decoration:none; font-weight:500; }
.link-section a:hover { text-decoration:underline; }
</style>
</head>
<body>

<div class="container">
  <h1>üë®‚Äçüè´ Connexion Professeur</h1>
  <form id="loginForm">
    <div class="form-group">
      <label for="username">Nom d'utilisateur</label>
      <input type="text" id="username" name="username" required placeholder="prof_dupont">
    </div>
    <div class="form-group">
      <label for="password">Mot de passe</label>
      <input type="password" id="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button type="submit" id="submitBtn">Se connecter</button>
    <div id="errorDiv" class="error"></div>
    <div id="successDiv" class="success"></div>
  </form>
  <div class="link-section">
    <p>Pas encore inscrit ? <a href="register_prof.html">üìù Cr√©er un compte</a></p>
  </div>
</div>

<script>
const form = document.getElementById('loginForm');
const errorDiv = document.getElementById('errorDiv');
const successDiv = document.getElementById('successDiv');
const submitBtn = document.getElementById('submitBtn');

let isLoading = false;

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (isLoading) return;

  errorDiv.classList.remove('show');
  successDiv.classList.remove('show');
  errorDiv.textContent = '';
  successDiv.textContent = '';

  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  if (!username || !password) {
    errorDiv.textContent = '‚ùå Veuillez remplir tous les champs';
    errorDiv.classList.add('show');
    return;
  }

  isLoading = true;
  submitBtn.disabled = true;
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '‚è≥ Connexion...';

  try {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password, role: 'prof' })
    });

    // V√©rifier si c'est du JSON ou non
    const text = await response.text();
    let data;
    try { data = JSON.parse(text); } catch { 
      console.error("R√©ponse serveur non JSON:", text);
      throw new Error("Erreur serveur : r√©ponse invalide");
    }

    if (!response.ok) throw new Error(data.message || "Erreur de connexion");

    // On r√©cup√®re les infos du prof
    const prof = data.user;

    if (!prof) throw new Error("Utilisateur introuvable ou r√©ponse invalide");

    if (prof.statut !== 'valide') throw new Error("‚è≥ Votre compte est en attente de validation");

    // Sauvegarde dans localStorage
    localStorage.setItem('dernier_connecte', JSON.stringify({
      username: prof.username,
      prenom: prof.prenom,
      nom: prof.nom,
      role: 'prof',
      statut: prof.statut
    }));

    successDiv.textContent = '‚úÖ Connexion r√©ussie! Redirection...';
    successDiv.classList.add('show');
    setTimeout(() => {
      window.location.href = 'prof_dashboard.html';
    }, 1000);

  } catch (err) {
    console.error("Erreur connexion:", err);
    errorDiv.textContent = '‚ùå ' + err.message;
    errorDiv.classList.add('show');
  } finally {
    isLoading = false;
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
});
</script>
</body>
</html>
